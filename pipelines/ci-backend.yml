# =============================================================================
# CI Pipeline - Backend API (ASP.NET Core 8)
# =============================================================================
# Triggers on changes to backend code
# Builds, tests, and publishes artifacts for deployment
# =============================================================================

trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  paths:
    include:
      - src/backend/**
      - pipelines/ci-backend.yml

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - src/backend/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  projectPath: 'src/backend/DjoppieHive.API/DjoppieHive.API.csproj'
  solutionPath: 'src/backend/DjoppieHive.slnx'

stages:
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Backend API'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              projects: '$(solutionPath)'

          - task: DotNetCoreCLI@2
            displayName: 'Build solution'
            inputs:
              command: 'build'
              projects: '$(solutionPath)'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Run unit tests'
            inputs:
              command: 'test'
              projects: '$(solutionPath)'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage"'
            continueOnError: true

          - task: DotNetCoreCLI@2
            displayName: 'Publish API'
            inputs:
              command: 'publish'
              projects: '$(projectPath)'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/api'
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)/api'
              artifactName: 'backend-api'

  - stage: SecurityScan
    displayName: 'Security Analysis'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: SecurityJob
        displayName: 'Security Scan'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - script: |
              dotnet tool install --global security-scan || true
              dotnet tool install --global dotnet-retire || true
            displayName: 'Install security tools'

          - task: DotNetCoreCLI@2
            displayName: 'Check for vulnerable packages'
            inputs:
              command: 'custom'
              projects: '$(solutionPath)'
              custom: 'list'
              arguments: 'package --vulnerable --include-transitive'
            continueOnError: true
